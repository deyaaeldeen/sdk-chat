# SDK Chat Production Container (Native AOT)
# Multi-stage build with statically compiled extractors
#
# Build:
#   docker build -f Dockerfile.release -t sdk-chat:latest .
#
# Usage with GitHub Copilot (token auth):
#   docker run --rm \
#     -v "/path/to/sdk:/sdk" \
#     -e GH_TOKEN="ghp_..." \
#     sdk-chat:latest package sample generate /sdk
#
# Usage with GitHub Copilot (credentials file):
#   docker run --rm \
#     -v "/path/to/sdk:/sdk" \
#     -v "$HOME/.copilot:/root/.copilot:ro" \
#     sdk-chat:latest package sample generate /sdk
#
# Usage with OpenAI:
#   docker run --rm \
#     -v "/path/to/sdk:/sdk" \
#     -e OPENAI_API_KEY="sk-..." \
#     sdk-chat:latest package sample generate /sdk --use-openai
#
# MCP server:
#   docker run --rm -i -e GH_TOKEN="ghp_..." \
#     sdk-chat:latest mcp
#
# Wrapper scripts (recommended):
#   ./scripts/sdk-chat.sh package sample generate /path/to/sdk
#   .\scripts\sdk-chat.ps1 package sample generate C:\path\to\sdk

# ============================================================================
# Stage 1: Build .NET Native AOT
# ============================================================================
FROM mcr.microsoft.com/dotnet/sdk:10.0 AS build-dotnet

RUN apt-get update && apt-get install -y --no-install-recommends \
    clang zlib1g-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /src
COPY sdk-chat.sln Directory.Build.props ./
COPY src/Microsoft.SdkChat/Microsoft.SdkChat.csproj src/Microsoft.SdkChat/
COPY src/AgentClientProtocol.Sdk/AgentClientProtocol.Sdk.csproj src/AgentClientProtocol.Sdk/
COPY src/AgentClientProtocol.Sdk.Generators/AgentClientProtocol.Sdk.Generators.csproj src/AgentClientProtocol.Sdk.Generators/
COPY src/ApiExtractor.Contracts/ApiExtractor.Contracts.csproj src/ApiExtractor.Contracts/
COPY src/ApiExtractor.DotNet/ApiExtractor.DotNet.csproj src/ApiExtractor.DotNet/
COPY src/ApiExtractor.Python/ApiExtractor.Python.csproj src/ApiExtractor.Python/
COPY src/ApiExtractor.Java/ApiExtractor.Java.csproj src/ApiExtractor.Java/
COPY src/ApiExtractor.Go/ApiExtractor.Go.csproj src/ApiExtractor.Go/
COPY src/ApiExtractor.TypeScript/ApiExtractor.TypeScript.csproj src/ApiExtractor.TypeScript/
COPY src/ src/

RUN dotnet restore src/Microsoft.SdkChat/Microsoft.SdkChat.csproj -r linux-x64 && \
    dotnet publish src/Microsoft.SdkChat/Microsoft.SdkChat.csproj \
        -c Release -r linux-x64 --self-contained -p:PublishAot=true \
        -p:InvariantGlobalization=true \
        -p:TreatWarningsAsErrors=false -o /app

# ============================================================================
# Stage 2: Build Go extractor (fully static, no glibc/musl dependency)
# ============================================================================
FROM golang:1.22-alpine AS build-go

WORKDIR /src
COPY src/ApiExtractor.Go/extract_api.go .
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
    -ldflags='-s -w' \
    -o /go_extractor extract_api.go

# ============================================================================
# Stage 3: Build Java extractor (JBang native, glibc-linked)
# ============================================================================
FROM ghcr.io/graalvm/native-image-community:21 AS build-java

ENV JBANG_DIR=/opt/jbang
RUN curl -Ls https://sh.jbang.dev | bash -s - app setup
ENV PATH="$PATH:/opt/jbang/bin"

WORKDIR /src
COPY src/ApiExtractor.Java/ExtractApi.java .
# Build glibc-linked native image with initialization options
RUN jbang export native --fresh --force -O java_extractor ExtractApi.java

# ============================================================================
# Stage 4: Build Python extractor (PyInstaller, glibc-linked)
# ============================================================================
FROM debian:bookworm-slim AS build-python

RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 python3-pip python3-venv python3-dev binutils libpython3.11 \
    && pip3 install --break-system-packages --no-cache-dir pyinstaller \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /src
COPY src/ApiExtractor.Python/extract_api.py .
RUN pyinstaller --onefile --strip --name python_extractor extract_api.py

# Copy the glibc-linked binary
RUN cp dist/python_extractor /python_extractor

# ============================================================================
# Stage 5: Build TypeScript extractor (Bun compile, glibc-linked)
# ============================================================================
FROM oven/bun:1-debian AS build-typescript

WORKDIR /src

# Copy package files and source
COPY src/ApiExtractor.TypeScript/package.json src/ApiExtractor.TypeScript/package-lock.json* ./
COPY src/ApiExtractor.TypeScript/src/ ./src/

# Install dependencies and build TypeScript
RUN bun install && bun run build

# Compile to native binary
RUN bun build --compile --minify ./dist/extract_api.js --outfile ts_extractor

# ============================================================================
# Stage 6: Download Copilot CLI
# ============================================================================
FROM debian:bookworm-slim AS build-copilot

RUN apt-get update && apt-get install -y --no-install-recommends \
    curl ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Install GitHub Copilot CLI
RUN curl -fsSL https://gh.io/copilot-install | bash

# ============================================================================
# Stage 7: Runtime (debian slim - compatible glibc for all native extractors)
# ============================================================================
FROM debian:bookworm-slim AS runtime

LABEL org.opencontainers.image.source="https://github.com/deyaaeldeen/sdk-chat"
LABEL org.opencontainers.image.description="SDK Chat (Native AOT)"

# Install minimal runtime dependencies (libstdc++ for C++ code in extractors)
RUN apt-get update && apt-get install -y --no-install-recommends \
    libstdc++6 ca-certificates \
    && rm -rf /var/lib/apt/lists/*

ARG USER_ID=1000
ARG GROUP_ID=1000
RUN groupadd -g ${GROUP_ID} sdkchat && \
    useradd -u ${USER_ID} -g sdkchat -m -s /bin/bash sdkchat

WORKDIR /app

# Copy all binaries
COPY --from=build-dotnet /app/Microsoft.SdkChat /app/sdk-chat
COPY --from=build-go /go_extractor /app/go_extractor
COPY --from=build-java /src/java_extractor /app/java_extractor
COPY --from=build-python /python_extractor /app/python_extractor
COPY --from=build-typescript /src/ts_extractor /app/ts_extractor
COPY --from=build-copilot /usr/local/bin/copilot /usr/local/bin/copilot

# Copy CA certificates for HTTPS
COPY --from=build-dotnet /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/

RUN chown -R sdkchat:sdkchat /app

ENV HOME="/home/sdkchat"
ENV PATH="/usr/local/bin:$PATH"

USER sdkchat

ENTRYPOINT ["/app/sdk-chat"]
CMD ["--help"]
