# SDK Chat Production Container (Native AOT)
# Multi-stage build with native AOT compilation
#
# Build:
#   docker build -f Dockerfile.release -t sdk-chat:latest .
#
# Usage with GitHub Copilot:
#   docker run --rm \
#     -v "/path/to/sdk:/sdk" \
#     -e COPILOT_GITHUB_TOKEN="gho_..." \
#     sdk-chat:latest package sample generate /sdk
#
# Usage with OpenAI:
#   docker run --rm \
#     -v "/path/to/sdk:/sdk" \
#     -e OPENAI_API_KEY="sk-..." \
#     sdk-chat:latest package sample generate /sdk --use-openai
#
# MCP server:
#   docker run --rm -i -e COPILOT_GITHUB_TOKEN="gho_..." \
#     sdk-chat:latest mcp

# ============================================================================
# Stage 1: Build (Native AOT)
# ============================================================================
FROM mcr.microsoft.com/dotnet/sdk:10.0 AS build

# Install AOT compilation toolchain
RUN apt-get update && apt-get install -y --no-install-recommends \
    clang zlib1g-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /src

# Copy project files first for layer caching
COPY sdk-chat.sln Directory.Build.props ./
COPY src/Microsoft.SdkChat/Microsoft.SdkChat.csproj src/Microsoft.SdkChat/
COPY src/AgentClientProtocol.Sdk/AgentClientProtocol.Sdk.csproj src/AgentClientProtocol.Sdk/
COPY src/AgentClientProtocol.Sdk.Generators/AgentClientProtocol.Sdk.Generators.csproj src/AgentClientProtocol.Sdk.Generators/
COPY src/ApiExtractor.Contracts/ApiExtractor.Contracts.csproj src/ApiExtractor.Contracts/
COPY src/ApiExtractor.DotNet/ApiExtractor.DotNet.csproj src/ApiExtractor.DotNet/
COPY src/ApiExtractor.Python/ApiExtractor.Python.csproj src/ApiExtractor.Python/
COPY src/ApiExtractor.Java/ApiExtractor.Java.csproj src/ApiExtractor.Java/
COPY src/ApiExtractor.Go/ApiExtractor.Go.csproj src/ApiExtractor.Go/
COPY src/ApiExtractor.TypeScript/ApiExtractor.TypeScript.csproj src/ApiExtractor.TypeScript/

# Copy full source
COPY src/ src/

# Restore and publish as native AOT
RUN dotnet restore src/Microsoft.SdkChat/Microsoft.SdkChat.csproj -r linux-x64 && \
    dotnet publish src/Microsoft.SdkChat/Microsoft.SdkChat.csproj \
        -c Release -r linux-x64 --self-contained -p:PublishAot=true \
        -p:TreatWarningsAsErrors=false -o /app

# ============================================================================
# Stage 2: Runtime (Native AOT binary + language runtimes)
# ============================================================================
FROM ubuntu:24.04 AS runtime

LABEL org.opencontainers.image.source="https://github.com/deyaaeldeen/sdk-chat"
LABEL org.opencontainers.image.description="SDK Chat (Native AOT)"

# Install language runtimes for API extractors
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 nodejs golang-go curl ca-certificates \
    && rm -rf /var/lib/apt/lists/* \
    && groupadd --gid 1001 sdkchat && useradd --uid 1001 --gid sdkchat --create-home sdkchat

# Install JBang for Java
ENV JBANG_DIR=/opt/jbang
ENV PATH="$PATH:/opt/jbang/bin:/usr/local/bin"
RUN curl -Ls https://sh.jbang.dev | bash -s - app setup \
    && chmod -R a+rx /opt/jbang && mkdir -p /opt/jbang/cache && chmod -R a+rwx /opt/jbang/cache

# Install GitHub Copilot CLI
RUN curl -fsSL https://gh.io/copilot-install | bash

# Copy native AOT binary and extractors
WORKDIR /app
COPY --from=build /app/Microsoft.SdkChat /app/sdk-chat
COPY src/ApiExtractor.Python/extract_api.py src/ApiExtractor.TypeScript/extract_api.mjs \
     src/ApiExtractor.Go/extract_api.go src/ApiExtractor.Java/ExtractApi.java /app/

# Security: Run as non-root user
USER sdkchat

HEALTHCHECK CMD /app/sdk-chat doctor || exit 1
ENTRYPOINT ["/app/sdk-chat"]
CMD ["--help"]
